apiVersion: apps/v1
kind: Deployment
metadata:
  name: flower-supernode
  namespace: {{ .FlowerAddonNamespace | default "flower-addon" }}
  labels:
    app.kubernetes.io/name: flower-addon
    app.kubernetes.io/component: supernode
    cluster: {{ .ClusterName }}
spec:
  replicas: 1
  selector:
    matchLabels:
      app.kubernetes.io/name: flower-addon
      app.kubernetes.io/component: supernode
  template:
    metadata:
      labels:
        app.kubernetes.io/name: flower-addon
        app.kubernetes.io/component: supernode
        cluster: {{ .ClusterName }}
    spec:
      serviceAccountName: flower-supernode
      containers:
      - name: supernode
        image: {{ .Image | default "flwr/supernode:1.15.0" }}
        imagePullPolicy: {{ .ImagePullPolicy | default "IfNotPresent" }}
        args:
        - "flower-supernode"
        - "--root-certificates=/certs/tls.crt"
        - "--superlink={{ .SuperLinkAddress }}:{{ .SuperLinkPort | default 9092 }}"
        - "--node-config=partition-id={{ .PartitionID }} num-partitions={{ .NumPartitions }}"
        - "--isolation=subprocess"
        - "--clientappio-api-address=0.0.0.0:9094"
        ports:
        - name: clientappio
          containerPort: 9094
          protocol: TCP
        volumeMounts:
        - name: flower-certs
          mountPath: /certs
          readOnly: true
        resources:
          requests:
            cpu: 100m
            memory: 256Mi
          limits:
            cpu: 1000m
            memory: 1Gi
        livenessProbe:
          tcpSocket:
            port: 9094
          initialDelaySeconds: 30
          periodSeconds: 10
        readinessProbe:
          tcpSocket:
            port: 9094
          initialDelaySeconds: 5
          periodSeconds: 5
      volumes:
      - name: flower-certs
        secret:
          secretName: flower-addon-flower.io-flower-ca-client-cert
          optional: false
