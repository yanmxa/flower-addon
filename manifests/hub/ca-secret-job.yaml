apiVersion: batch/v1
kind: Job
metadata:
  name: flower-ca-generator
  namespace: open-cluster-management
  labels:
    app.kubernetes.io/name: flower
    app.kubernetes.io/component: ca-generator
spec:
  ttlSecondsAfterFinished: 300
  template:
    spec:
      restartPolicy: OnFailure
      serviceAccountName: flower-ca-generator
      containers:
      - name: ca-generator
        image: alpine/openssl:latest
        command:
        - /bin/sh
        - -c
        - |
          set -e

          # Generate CA key and certificate
          openssl genrsa -out /tmp/ca.key 4096
          openssl req -x509 -new -nodes -key /tmp/ca.key -sha256 -days 3650 \
            -out /tmp/ca.crt \
            -subj "/C=US/ST=CA/L=San Francisco/O=Flower/OU=FL/CN=Flower CA"

          # Generate SuperLink server key and CSR
          openssl genrsa -out /tmp/server.key 4096

          cat > /tmp/server.cnf << EOF
          [req]
          default_bits = 4096
          prompt = no
          default_md = sha256
          req_extensions = req_ext
          distinguished_name = dn

          [dn]
          C = US
          ST = CA
          L = San Francisco
          O = Flower
          OU = FL
          CN = superlink

          [req_ext]
          subjectAltName = @alt_names

          [alt_names]
          DNS.1 = superlink
          DNS.2 = superlink.flower-system
          DNS.3 = superlink.flower-system.svc
          DNS.4 = superlink.flower-system.svc.cluster.local
          DNS.5 = localhost
          IP.1 = 127.0.0.1
          EOF

          openssl req -new -key /tmp/server.key -out /tmp/server.csr -config /tmp/server.cnf

          # Sign the server certificate
          openssl x509 -req -in /tmp/server.csr -CA /tmp/ca.crt -CAkey /tmp/ca.key \
            -CAcreateserial -out /tmp/server.crt -days 365 -sha256 \
            -extfile /tmp/server.cnf -extensions req_ext

          # Create Kubernetes secrets using kubectl
          echo "CA and server certificates generated successfully"
          cat /tmp/ca.crt
        volumeMounts:
        - name: certs
          mountPath: /tmp
      volumes:
      - name: certs
        emptyDir: {}
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: flower-ca-generator
  namespace: open-cluster-management
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: flower-ca-generator
  namespace: open-cluster-management
rules:
- apiGroups: [""]
  resources: ["secrets"]
  verbs: ["create", "get", "update", "patch"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: flower-ca-generator
  namespace: open-cluster-management
subjects:
- kind: ServiceAccount
  name: flower-ca-generator
  namespace: open-cluster-management
roleRef:
  kind: Role
  name: flower-ca-generator
  apiGroup: rbac.authorization.k8s.io
